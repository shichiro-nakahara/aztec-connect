#!/bin/bash
set -e

export TEST=$1
export MAINNET_FORK=$2
export NUM_INNER_ROLLUP_TXS=${3:-3}
export NUM_OUTER_ROLLUP_PROOFS=${4:-2}
export VK=$5

if [ "$MAINNET_FORK" = "true" ]; then
  export CHAIN_ID='--chain.chainId=0xA57EC'
  export FORK_HOST='-f=https://mainnet.infura.io/v3/6a04b7c89c5b421faefde663f787aa35'
  export FORK_BLOCK='--fork.blockNumber=14000000'
fi

if [ -z "$VK" ]; then
  export PROVERLESS=true
fi

$(aws ecr get-login --region us-east-2 --no-include-email) 2> /dev/null

docker pull 278380418400.dkr.ecr.us-east-2.amazonaws.com/falafel:cache-$COMMIT_HASH
docker pull 278380418400.dkr.ecr.us-east-2.amazonaws.com/halloumi:cache-$COMMIT_HASH
docker pull 278380418400.dkr.ecr.us-east-2.amazonaws.com/end-to-end:cache-$COMMIT_HASH

docker tag 278380418400.dkr.ecr.us-east-2.amazonaws.com/falafel:cache-$COMMIT_HASH 278380418400.dkr.ecr.eu-west-2.amazonaws.com/falafel:latest
docker tag 278380418400.dkr.ecr.us-east-2.amazonaws.com/halloumi:cache-$COMMIT_HASH 278380418400.dkr.ecr.eu-west-2.amazonaws.com/halloumi:latest
docker tag 278380418400.dkr.ecr.us-east-2.amazonaws.com/end-to-end:cache-$COMMIT_HASH 278380418400.dkr.ecr.eu-west-2.amazonaws.com/end-to-end:latest

docker-compose up --exit-code-from end-to-end