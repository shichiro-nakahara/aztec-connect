#!/usr/bin/env bash

# set -x

if [[ $EUID -ne 0 ]]; then
    echo "You must be root to run this script"
    exit 1
fi

USER=$1

# Returns all available interfaces, except "lo" and "veth*".
available_interfaces()
{
   local ret=()

   local ifaces=$(ip li sh | cut -d " " -f 2 | tr "\n" " ")
   read -a arr <<< "$ifaces" 

   for each in "${arr[@]}"; do
      each=${each::-1}
      if [[ ${each} != "lo" && ${each} != veth* ]]; then
         ret+=( "$each" )
      fi
   done
   echo ${ret[@]}
}

IFACE="$2"
if [[ -z "$IFACE" ]]; then
   ifaces=($(available_interfaces))
   if [[ ${#ifaces[@]} -gt 0 ]]; then
      IFACE=${ifaces[0]}
      #echo "Using interface $IFACE"
   else
      echo "Usage: ./netns <USER> <IFACE>"
      exit 1
   fi
fi

NS=$USER
VETH="veth_$USER"
VPEER="vpeer_$USER"

if [ ! -f /run/netns/$NS ]; then
   # Create namespace.
   ip netns add $NS

   # Create veth link.
   ip link add $VETH type veth peer name $VPEER

   # Add VPEER interface to NS.
   ip link set $VPEER netns $NS

   # Add VETH interface to bridge.
   ip link set $VETH master br0
   ip link set $VETH up

   # Setup IP.
   HWADDR=5a$(echo $USER | sha256sum | xxd -r -p | head -c5 | hexdump -v -e '/1 ":%02x"')
   ip netns exec $NS ip link set $VPEER address $HWADDR
   ip netns exec $NS ip link set $VPEER up
   ip netns exec $NS ip link set lo up
   ip netns exec $NS dhclient $VPEER
fi

# Get into namespace.
ip netns exec ${NS} sudo -u $USER -i --preserve-env=SSH_AUTH_SOCK,SSH_CLIENT,SSH_CONNECTION,SSH_TTY
